<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>商品详情</title>
		<link rel="stylesheet" href="../resource/css/mui.min.css" />
		<link rel="stylesheet" href="../resource/css/common.css" />
		<link rel="stylesheet" href="../resource/css/product.css" />
		<link rel="stylesheet" href="../resource/css/swiper.min.css" />
	</head>
	<body>
		<div class="mui-content">
			<div class="protop">
				<div class="pro-icon">
					<a href="javascript:void(0);" class="pro-icon-back" onclick="history.go(-1);"><img src="../resource/images/back.png" alt=""/></a>
					<a href="tel:12345678" class="pro-icon-tel"><img src="../resource/images/tel.png" alt="" /></a>
					<a href="" class="pro-icon-cart cartproid"><img src="../resource/images/shoppingcart.png" alt="" /></a>
				</div>
			</div>
			<div class="pro-content">
					
			</div>
		</div>
		
		<nav class="index-bar index-bar-tab">
			<a class="index-tab-item" style="width:2px;border-right: 1px solid #ccc;" id="itemcollect">
				<span class="index-icon nav-logo">
					<img src="../resource/images/icon_favorite.png" alt="" />
				</span>
				<span class="index-tab-label">收藏</span>
				<span id="hide" style="display: none;"></span>
			</a>
			<a class="index-tab-item cartproid" href="" style="width:2px;border-right: 1px solid #ccc;">
				<span class="index-icon nav-logo cartnum">
					<img src="../resource/images/icon_gouwuche.png" alt="" />
					<span id="cartnum">0</span>
				</span>
				<span class="index-tab-label">购物车</span>
			</a>
			<a class="index-tab-item" style="border-right: 1px solid #ccc;" id="addcart1">
				
				<span class="index-tab-label">加入购物车</span>
			</a>
			<a class="index-tab-item" id="buy" style="color: #fff;background: #ef503a;">
				
				<span class="index-tab-label">立即购买</span>
			</a>
		</nav>
		<div class="pro-mask">
			<div class="pro-mask-content">
				<div class="pro-mask-title">
					<img src="" alt="" />	
					<div class="pro-title-right">
						<div class="pro-title-content">
							<div class="pro-title-item">
								价格：¥<span id="pro-mask-price">0</span>
							</div>
							<p><span id="pro-spec"></span>(库存：<span id="pro-spec-stock">0</span>)</p>
						</div>	
					</div>
					<span class="pro-close">×</span>
				</div>
				<div class="pro-body">
					<div class="pro-body-item">
						<label>规格</label>
						<div class="pro-spec-item">
							
						</div>
					</div>
					<div class="pro-body-item">
						<label>购买数量</label>
						<div class="mui-numbox" data-numbox-min="1">
							<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
							<input class="mui-input-numbox" type="number" id="num">
							<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
						</div>
					</div>
					<div class="pro-btn pro-btn-cart">
						<button id="addCart">加入购物车</button>
					</div>
					<div class="pro-btn pro-btn-buy">
						<button id="tobuy">立即购买</button>
					</div>	
				</div>
			</div>
		</div>
		<div class="servicemask">
			<div class="service">
				<div class="servicecontent">
					<span class="serviceclose">x</span>
					<h1>服务保障</h1>
					<ul>
						<li>
							<div><img src="../resource/images/renzheng_service.png" alt="" /><span>商家认证</span></div>
							<p>该商家已在工商部门登记注册，并已通过实名认证，身份真实可信</p>
						</li>
						<li>
							<div><img src="../resource/images/protect_service.png" alt="" /><span>酒趣担保</span></div>
							<p>该商家已开通担保交易服务，贷款将由酒趣担保，在买家确认收货后再结算给卖家</p>
						</li>
						<li>
							<div><img src="../resource/images/wechatpay_service.png" alt="" /><span>微信支付</span></div>
							<p>该商家店铺支持使用微信支付</p>
						</li>
						<li>
							<div><img src="../resource/images/alipay_service.png" alt="" /><span>支付宝支付</span></div>
							<p>该商家店铺支持使用支付宝支付</p>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<script id="entry-template" type="text/x-handlebars-template">
			  <div class="pro-banner">
					<div id="slideBox" class="slideBox">
						<div class="hd">
							<ul></ul>
						</div>
						<div class="bd">
							<ul>{{imgUrl.url}}
								{{#each productData.pictures}}
									<li>
										<a class="pic" href=""><img src="{{../productData.imgUrl}}{{this}}" /></a>
									</li>
								{{/each}}
							</ul>
						</div>
					</div>
				</div>
				<div class="pro-item">
					<p>{{productData.title}}</p>
					<div class="pro-price">
						<span>¥{{productData.shopPrice}}</span>
						<span>¥{{productData.marketPrice}}</span><label style="font-size: 12px;color: #666;margin-left: 4px;">({{productData.sku}})</label>
					</div>
					<p style="font-size: 12px;margin-top: 6px;">{{productData.subtitle}}</p>
					<div class="pro-brief">
						<span><img src="../resource/images/rz1.png" alt="" />酒趣担保交易</span>
						<span><img src="../resource/images/rz1.png" alt="" />微信支付</span>
						<span><img src="../resource/images/rz1.png" alt="" />支付宝支付</span>
						<img src="../resource/images/icon_more.png" alt="" />
					</div>
				</div>
				<div class="shop-item">
					<div class="shop-container">
						<div class="shop-img">
							<img src="{{productData.imgUrl}}{{productData.logo}}" alt="" id="shopImg"/>
						</div>
						<div class="shop-middle">
							<div class="shop-middle-content">
								<p id="shopName">{{productData.shopName}}</p>
								{{#renzhen productData.check}}{{/renzhen}}
							</div>
						</div>
						<a href="" id="entershop">进入店铺</a>
					</div>
				</div>
				<!--<div class="product-pull">
					<p>——————&nbsp;&nbsp;上拉查看更多详情&nbsp;&nbsp;——————</p>
					<div><img src="../resource/images/icon_up.png" alt="" /></div>
				</div>-->
				
		</script>
		<script id="procontent" type="text/x-handlebars-template">
			<div id="leftTabBox" class="tabBox">
				<div class="hd">
					<ul>
						<li class="on">图文详情</li>
						<li>商品参数</li>
						<div class="clear"></div>
					</ul>
				</div>
				<div class="bd" id="tabBox1-bd">
					<div class="con">
						<ul>
							{{{productData.desc}}}
						</ul>
					</div>
					<div class="con propic">
						<table>
							{{#each productData.props}}
							<tr><th width="100">{{@key}}</th><td>{{this}}</td></tr>
							{{/each}}
						</table>
					</div>
				</div>
			</div>
		</script>
		<script type="text/javascript" src="../resource/js/jquery.min.js"></script>
		<script type="text/javascript" src="../resource/js/handlebars.min.js"></script>
		<script type="text/javascript" src="../resource/js/server.js"></script>
		<script type="text/javascript" src="../resource/js/common.js"></script>
		<script type="text/javascript" src="../resource/js/TouchSlide.1.1.js"></script>
		<script type="text/javascript" src="../resource/js/mui.min.js"></script>
		<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<script type="text/javascript">
			$(function(){
				var hadload = false;
				itemId = getUrlParam('itemId');
				shopId = getUrlParam('shopId');
				getProduct();
				
				$("#addCart").click(function(){
					addCart();
				});
				
				$(".pro-close").click(function(){
					$(".pro-mask").hide();
				})
				$("#tobuy").click(function(){
					jsonp("/user/core/my_info?requestType=1&version=1.0","post",{shopId:shopId},function(data,status){
						if(data.flag == -1){
							isLogin(shopId,null,2,itemId);
						}
						else{
							var dataid = $("#tobuy").attr("dataid");
							var num = $("#num").val();
							if(dataid){
								window.location.href = "order.html?shopId="+shopId+"&&itemId="+dataid+"&&num="+num;
							}
							else{
								window.location.href = "order.html?shopId="+shopId+"&&itemId="+itemId+"&&num="+num;
							}
							
						}
						
					},function(err){
						alert("出错了")
					})
					
				});
				$("#itemcollect").click(function(){
					status = $("#hide").html();
					if(status == 0){
						collectitem(1);	
					}
					else if(status == 1){
						collectitem(0);
					}
				})
				function getProduct(){	
					jsonp("/weixin/itemDetail?requestType=1&version=1.0","post",{itemId:itemId,shopId:shopId},function(data,status){
						productData = data;
						productData.data.imgUrl = imgUrl;
						shopId = productData.data.shopId;
						Handlebars.registerHelper("renzhen",function(item,options){
					  		var out = "";
					  		var num = 0;
					  		if(item == 4 || item == 5 || item == 6){
					  			out = '<img src="../resource/images/rz.png" alt="" />';
					  		}
					  		else{
					  			out = '<img src="../resource/images/unrz.png" alt="" />';
					  		}
				           return out;
				         });
						$(".cartproid").attr("href","cart.html?shopId="+shopId);
						var source = $("#entry-template").html();
						var template = Handlebars.compile(source);
						console.log(productData);
						var html = template({productData:productData.data});
						
						var sourcepro = $("#procontent").html();
						var templatepro = Handlebars.compile(sourcepro);
						htmlpro = templatepro({productData:productData.data});
						share();
						/*alert(productData.data.brief);*/
						$(".protop .pro-icon").after(html);
						$("#cartnum").html(productData.data.cartNum);
						$("#hide").html(productData.data.collectStatus);
						$(".pro-icon-tel").attr("href","tel:"+data.data.mobile);
						if(productData.data.collectStatus == 0){
							$("#itemcollect span img").attr("src","../resource/images/icon_favorite.png")
						}
						else{
							$("#itemcollect span img").attr("src","../resource/images/icon_favorites_sel.png")
						}
						$("#entershop").attr("href","index.html?shopId="+data.data.shopId);
						
						TouchSlide({ 
							slideCell:"#slideBox",
							titCell:".hd ul", //开启自动分页 autoPage:true ，此时设置 titCell 为导航元素包裹层
							mainCell:".bd ul", 
							effect:"leftLoop", 
							autoPage:true,//自动分页
							autoPlay:true, //自动播放
							delayTime:400
						});
						$(".pro-brief").click(function(){
							$(".servicemask").show();
						});
						$(".serviceclose").click(function(){
							$(".servicemask").hide();
						});
						if(productData.data.approveStatus == "onsale"){
							$("#buy").click(function(){
								squ();
								$(".pro-mask,.pro-btn-buy").show();
								$(".pro-btn-cart").hide();
							});
							$("#addcart1").click(function(){
								squ();
								$(".pro-mask,.pro-btn-cart").show();
								$(".pro-btn-buy").hide();
							});
						}
						else{
							$("#buy").css("background","#ccc");
							alert("此商品已下架");
						}
						
					},function(err){
						alert("出错了");
					})
				}
				function squ(){
					jsonp("/weixin/itemSku?requestType=1&version=1.0","post",{itemId:itemId,shopId:shopId},function(data,status){
						console.log(data);
						if(data.flag == 0){
							/*show(productData.data);*/
							$(".pro-mask-title img").attr("src",imgUrl+productData.data.pictures[0]+"_150x150.jpg");
							$("#pro-mask-price").html(productData.data.shopPrice);
							$("#pro-spec-stock").html(productData.data.stock);
							sepcHtml = "<span class='spec-active'>默认</span>";
							$(".pro-spec-item").html(sepcHtml);
						}
						else if(data.flag == 1){
							show(data.data[0]);
							var sepcHtml = "";
							sepcHtml += "<span class='spec-active'>"+data.data[0].skuProps+"</span>";
							$("#tobuy").attr("dataid",data.data[0].itemId);
							for(i=1;i<data.data.length;i++){	
								sepcHtml += "<span>"+data.data[i].skuProps+"</span>";
							}
							$(".pro-spec-item").html(sepcHtml);
							$(".pro-spec-item span").click(function(){
								$(".pro-spec-item span").removeClass("spec-active");
								$(this).addClass("spec-active");
								var index = $(this).index();
								$("#tobuy").attr("dataid",data.data[index].itemId);
								show(data.data[index]);
							})
						}
						else if(data.flag == -1){
							isLogin(shopId,null,2,itemId);
						}
						
					},function(err){
						alert("出错了");
					})
				}
				function show(data){
					$(".pro-mask-title img").attr("src",imgUrl+data.picture+"_150x150.jpg");
					$("#pro-mask-price").html(data.price);
					if(data.skuProps){
						$("#pro-spec").html("已选规格:“"+data.skuProps+"”");
						$("#num").attr("data-itemProps",data.skuProps);
					}
					$("#pro-spec-stock").html(data.stock);
					$(".mui-numbox").attr("data-numbox-max",data.stock);
					mui.init();
					mui(".mui-numbox").numbox();
					$("#num").attr("dataitemId",data.itemId);
				}
				function addCart(){
					var num = $("#num").val();
					var itemid = $("#num").attr("dataitemId");
					var itemProps = "";
					if($("#num").data("itemprops")){
						var itemProps = $("#num").data("itemprops");
					}	
					jsonp("/user/core/addCart?requestType=1&version=1.0","post",{shopId:shopId,itemId:itemid,num:num,itemProps:itemProps},function(data,status){
						console.log(data);
						if(data.flag == -1){
							isLogin(shopId,null,2,itemId);
						}
						else{
							$(".pro-mask").hide();
							mui.toast(data.message);
							$("#cartnum").html(data.cartNum);
						}
						
					},function(err){
						alert("出错了");
					});
				}
				function collectitem(state){
					jsonp("/user/core/collectItem?requestType=1&version=1.0","post",{itemId:itemId,state:state,shopId:shopId},function(data,status){
						if(data.flag == -1){
							isLogin(shopId,null,2,itemId);
						}
						else{
							if(state == 1){
								$("#hide").html(1);
								$("#itemcollect span img").attr("src","../resource/images/icon_favorites_sel.png");
							}
							else{
								$("#hide").html(0);
								$("#itemcollect span img").attr("src","../resource/images/icon_favorite.png");
							}
						}
						
					},function(err){
						alert("出错了")
					})
				}
				
				$(window).scroll(function(){
			        if($(".protop").height()<=($(this).scrollTop()+$(window).height())) {
			        	if(!hadload){
			        	
			        		$(".pro-content").html(htmlpro);
	                        
	                        TouchSlide({slideCell:"#leftTabBox",
	                        endFun:function(i){ //高度自适应
								var bd = document.getElementById("tabBox1-bd");
								bd.parentNode.style.height = bd.children[i].children[0].offsetHeight+"px";
								if(i>0)bd.parentNode.style.transition="200ms";//添加动画效果
							}});
	                        var offset = $(".pro-content").offset().top;
	                        console.log(offset);
	                        $("body").animate({scrollTop:offset}, 1000);
	                        hadload = true;
			        	}
		        	}   
			    });
			    
			    /*微信分享*/
		   function share(){
			   var url = window.location.href;
			    
			    $.ajax({
			        type:'get',
			        url:baseurl+'/weixin/sign?requestType=1&version=1.0',
			        data:{url:url},
			        dataType:'JSON',
			        error:function(err){},
			        success:function(data,status){
			            wx.config({
			                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
			                appId: data.appId, // 必填，公众号的唯一标识
			                timestamp: data.sign.timestamp, // 必填，生成签名的时间戳
			                nonceStr: data.sign.nonceStr, // 必填，生成签名的随机串
			                signature: data.sign.signature,// 必填，签名，见附录1
			                jsApiList: ['onMenuShareTimeline','onMenuShareAppMessage'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
			            });
			        },
			        error: function(data) {
			          alert("出错了");
			        }
			
			    });
			    
			    wx.ready(function() {
				    var shareUrl = baseurl+"/pages/mall/product.html?shopId="+shopId+"&itemId="+itemId;//分享产品
				    var title = productData.data.shopName;
				    var shareImgUrl = productData.data.imgUrl+productData.data.pictures[0];
				    var des = productData.data.title+" | 价格：¥"+productData.data.shopPrice+"|"+productData.data.subtitle;
				    wx.onMenuShareTimeline({
				        title: title,
				        desc: des,
				        link: shareUrl,
				        imgUrl: shareImgUrl,
				        trigger: function(res) {
				
				        },
				        success: function(res) {
				        },
				        cancel: function(res) {
				           // window.location.href="http://admin.chinatoplady.cn/wxmmmg/order/toMyOrder?orderType=1";
				        },
				        fail: function(res) {
				            // alert(JSON.stringify(res));
				        }
				    });
				    wx.onMenuShareAppMessage({
				        title: title,
				        desc: des,
				        // 分享描述
				        link: shareUrl,
				        imgUrl: shareImgUrl,
				
				        type: '',
				        // 分享类型,music、video或link，不填默认为link
				        dataUrl: '',
				        // 如果type是music或video，则要提供数据链接，默认为空
				        trigger: function(res) {
				
				        },
				        success: function(res) {
				            
				        },
				        cancel: function(res) {
				           // window.location.href="http://admin.chinatoplady.cn/wxmmmg/order/toMyOrder?orderType=1";
				        },
				        fail: function(res) {
				            // alert(JSON.stringify(res));
				        }
				    });
				
				});
				}
				 
			});
		</script>
	</body>
</html>
